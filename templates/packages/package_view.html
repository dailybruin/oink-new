{% extends "packages/base.html" %} {% block content %}
<div class="title-row">
  <h1>{{ package.slug }}</h1>

  <a class="drive-link-title" 
     href="{{ package.google_drive_url }}" 
     target="_blank">
    <i data-lucide="folder"></i>
    Open Google Drive
  </a>
</div>

<div class="package-info">
  <p class="package-description">{{ package.description }}</p>
</div>

{{ initial_payload|json_script:"initial-payload" }}
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>


<div class="package-layout">
  <!-- Tabs + Fetch header -->
  <div class="tab-header">
    <div class="tab-header-tabs">
      <button
        class="tab-btn tab-btn-active"
        data-tab="images"
        type="button"
      >
        Images
      </button>
      <button
        class="tab-btn"
        data-tab="data"
        type="button"
      >
        Data
      </button>
    </div>

    <!-- Fetch button  -->
    <button
    id="fetch-btn"
    type="button"
    class="fetch-icon-btn"
    title="Fetch from Drive"
  >
  <i data-lucide="hard-drive"></i>
  </button>
  </div>

  <div class="tab-panels">
    <!-- IMAGES TAB -->
    <div id="tab-images" class="tab-panel tab-panel-active">
      
      <div class="images-toolbar">
        <!-- Search -->
        <div class="images-toolbar-left">
          <div class="images-search-wrapper">
            <input
              id="image-search"
              type="text"
              class="images-search-input"
              placeholder="Search"
            />
          </div>
        </div>
      
        <!-- Sort + View -->
        <div class="images-toolbar-right">
          <!-- Sort -->
          <button
            type="button"
            class="toolbar-trigger"
            id="sort-trigger"
          >
            <i class="toolbar-icon" data-lucide="arrow-up-down"></i>
            <span class="toolbar-label">Sort</span>
            <span class="toolbar-caret">▾</span>

            <select id="image-sort" class="images-select">
              <option value="original">Original</option>
              <option value="name-asc">File name A–Z</option>
              <option value="name-desc">File name Z–A</option>
            </select>
          </button>
      
          <!-- View -->
          <button type="button" class="toolbar-trigger" id="view-trigger">
            <i class="toolbar-icon" data-lucide="list"></i>
            <span class="toolbar-label">View</span>
            <span class="toolbar-caret">▾</span>
          
            <select id="image-view" class="images-select">
              <option value="grid">Grid</option>
              <option value="list">List</option>
            </select>
          </button>
        </div>
      </div>

      <!-- Grid + List containers -->
      <div id="images-panel" class="images-grid"></div>

      <div id="images-list-wrapper" class="images-list-wrapper">
        <div class="images-list-header">
          <span class="col-filename">File Name</span>
          <span class="col-filetype">File Type</span>
        </div>
        <ul id="images-list" class="images-list"></ul>
      </div>
    </div>

    <!-- DATA TAB -->
    <div id="tab-data" class="tab-panel">
      <div class="data-accordion">
        <!-- DATA SECTION -->
        <div class="data-section">
          <button type="button" class="data-section-header">
            <span>Data</span>
            <span class="data-section-caret">▾</span>
          </button>
          <div class="data-section-body">
            <pre id="data-container" class="data-pre">(none)</pre>
          </div>
        </div>
    
        <!-- METADATA SECTION -->
        <div class="data-section">
          <button type="button" class="data-section-header">
            <span>Metadata</span>
            <span class="data-section-caret">▾</span>
          </button>
          <div class="data-section-body">
            <pre id="meta-container" class="data-pre">{}</pre>
          </div>
        </div>
    
        <!-- PREVIEW SECTION -->
        <div class="data-section">
          <button type="button" class="data-section-header">
            <span>Preview</span>
            <span class="data-section-caret">▾</span>
          </button>
          <div class="data-section-body">
            <div id="article-container" class="data-preview">(no article loaded)</div>
          </div>
        </div>
      </div>
    </div>
    
</div>

<style>
  /* --- Title row: slug + drive link --- */
  .title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .drive-link-title {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 8px;
    color: #e86357;
    background: #ffe8e3;
    border: 1px solid #f4b8af;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
  }

  .drive-link-title:hover {
    background: #ffdcd3;
    border-color: #e59f96;
  }

  .drive-link-title svg {
    width: 17px;
    height: 17px;
    color: #e86357;
  }

/* --- Description text --- */
  .package-description {
    font-size: 16px;
    color: #444;
    margin: 0 0 20px;
    line-height: 1.55;
  }


  
  .package-layout {
    margin-top: 16px;
  }

  
  .tab-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .tab-header-tabs {
    display: inline-flex;
  }

  .tab-btn {
    padding: 10px 22px;
    background: #f5b4ac;    
    color: white;
    border: none;
    border-radius: 10px 10px 0 0; 
    font-size: 18px;
    font-weight: 500;
    cursor: pointer;
    margin-right: 0;
  }

  .tab-btn + .tab-btn {
    margin-left: -4px; 
  }

  .tab-btn-active {
    background:  #e86357;    
    color: white;
    font-weight: 600;
  }

  .tab-panels {
    margin-top: 4px;
  }

  .tab-panel {
    display: none;
  }

  .tab-panel-active {
    display: block;
  }

  /* Toolbar: search + sort + view */
  .images-toolbar {
    display: flex;
    align-items: center;
    gap: 16px;
    margin: 8px 0 20px;
  }

  .images-toolbar-left {
  flex: 1 1  auto;         
}

  .images-toolbar-right {
    margin-left: auto;    
    display: inline-flex;
    align-items: center;
    gap: 12px;               
  }


  .toolbar-group {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .images-toolbar-label {
    font-size: 14px;
    color: #333;
  }

  .images-select {
    position: absolute;
    inset: 0;         
    opacity: 0;    
    cursor: pointer;
    border: none;
    background: transparent;
    padding: 0;
    margin: 0;
  }

  /* Search bar styling */
  .images-search-wrapper {
    max-width: 390px;
    width: 100%;
    display: flex;
    align-items: center;
    border: 2px solid #d3d3d3;
    border-radius: 1200px;
    padding: 4px 12px;
    background: #fffaf8;
  }

  .images-search-input {
    border: none;
    outline: none;
    background: transparent;
    font-size: 14px;
    flex: 1;
  }

  /* Fetch button */
  .fetch-icon-btn {
    border: none;
    background: #e86357;
    border-radius: 12px;
    padding: 12px 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .fetch-icon-btn svg {
    display: block;
  }

  .fetch-icon-btn:hover {
    opacity: 0.9;
  }

  /* Images grid */
  .images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
  }

  .hidden {
    display: none !important;
  }

  /* Transparent image cards */
  .image-card {
    background: transparent;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .image-thumb {
    width: 100%;
    height: 180px;
    background: #f6f6f6;
    overflow: hidden;
    border: 1px solid #c9c9c9;
    border-radius: 0;
  }

  .image-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 0;
  }

  .image-url {
    font-size: 12px;
    color: #444;
    word-break: break-all;
    padding-left: 2px;
  }

  /* List view */
  .images-list-wrapper {
    margin-top: 16px;
    display: none;  
  }

  .images-list-header {
    display: grid;
    grid-template-columns: 1fr 120px; 
    font-size: 14px;
    font-weight: 600;
    color: #d56a55;
    margin-bottom: 8px;
  }

  .images-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  .images-list-row {
    display: grid;
    grid-template-columns: 1fr 120px;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
    border-bottom: 1px solid #eee;
  }

  .images-list-row a {
    color: #333;
    text-decoration: none;
    word-break: break-all;
  }

  .images-list-row a:hover {
    text-decoration: underline;
  }

  .col-filename {
    padding-right: 12px;
  }

  .col-filetype {
    text-align: left;
    color: #666;
  }


    .toolbar-trigger {
    position: relative;       
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    padding: 4px 0;
    font-size: 14px;
    color: #2b2525;
    cursor: pointer;
  }


  .toolbar-trigger svg {
    display: block;
  }

  .sort-icon,
  .menu-icon {
    stroke: #2b2525;
  }

  .caret-icon {
    stroke: #2b2525;
  }

    /* Data Tab Accordion Drop */

  .data-accordion {
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* individual section container */
  .data-section {
    border: 1px solid #ebd2c9;
    border-radius: 8px;
    background: #fff7f3;
    overflow: hidden;
  }

  /* header button */
  .data-section-header {
    width: 100%;
    padding: 10px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  /* caret arrow */
  .data-section-caret {
    font-size: 14px;
    transition: transform 0.15s ease-out;
  }


  .data-section-body {
    padding: 10px 14px 12px;
  }

  /* collapsed state: hide body */
  .data-section-collapsed .data-section-body {
    display: none;
  }

  /* rotate caret when collapsed */
  .data-section-collapsed .data-section-caret {
    transform: rotate(-90deg);
  }

  /* JSON / metadata styling */
  .data-pre {
    background: #fffaf8;
    border-radius: 6px;
    padding: 10px 12px;
    font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size: 13px;
    line-height: 1.45;
    color: #333;
    white-space: pre-wrap;
    max-height: 380px;
    overflow: auto;
    border: 1px solid #ebd2c9;
  }


  .data-preview h1 {
    font-size: 26px;
    margin-bottom: 8px;
  }

  .data-preview p {
    font-size: 15px;
    line-height: 1.6;
  }

  .fetch-icon-btn i,
  .fetch-icon-btn svg {
    color: white !important;
  }


</style>

<script>
  // HTML escape utility
  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // --- Images state + rendering ---
  let currentImages = [];
  let currentViewMode = "grid"; // "grid" or "list"
  let currentSearchTerm = "";   // search text

  function applyImageViewMode() {
    const grid = document.getElementById("images-panel");
    const listWrapper = document.getElementById("images-list-wrapper");
    if (!grid || !listWrapper) return;

    if (currentViewMode === "grid") {
      grid.style.display = "grid";
      listWrapper.style.display = "none";
    } else {
      grid.style.display = "none";
      listWrapper.style.display = "block";
    }
  }

  function renderImages() {
    const imagesPanel = document.getElementById("images-panel");
    const imagesList = document.getElementById("images-list");
    if (!imagesPanel || !imagesList) return;

    imagesPanel.innerHTML = "";
    imagesList.innerHTML = "";

    if (!currentImages || currentImages.length === 0) {
      applyImageViewMode();
      return;
    }

    // Copy & filter by search
    let imgs = currentImages.slice();
    if (currentSearchTerm) {
      const q = currentSearchTerm.toLowerCase();
      imgs = imgs.filter(it => {
        const name = (it.name || "").toLowerCase();
        const url = (it.url || "").toLowerCase();
        return name.includes(q) || url.includes(q);
      });
    }

    // Sort selection
    const sortSelect = document.getElementById("image-sort");
    const sortValue = sortSelect ? sortSelect.value : "original";

    if (sortValue === "name-asc" || sortValue === "name-desc") {
      imgs.sort((a, b) => {
        const nameA = (a.name || a.url || "").toLowerCase();
        const nameB = (b.name || b.url || "").toLowerCase();
        if (nameA < nameB) return sortValue === "name-asc" ? -1 : 1;
        if (nameA > nameB) return sortValue === "name-asc" ? 1 : -1;
        return 0;
      });
    }

    // GRID thumbnails
    imgs.forEach((it) => {
      if (!it.url) return;

      const card = document.createElement("div");
      card.className = "image-card";

      const thumb = document.createElement("div");
      thumb.className = "image-thumb";

      const img = document.createElement("img");
      img.src = it.url;
      img.alt = it.name || "image";

      img.onerror = function () {
        this.style.display = "none";
        const errorMsg = document.createElement("div");
        errorMsg.textContent = "Failed to load image";
        errorMsg.className = "text-danger small";
        thumb.appendChild(errorMsg);
      };

      thumb.appendChild(img);
      card.appendChild(thumb);

      const link = document.createElement("div");
      link.className = "image-url";
      link.textContent = it.url;  // keep your original URL format

      card.appendChild(link);
      imagesPanel.appendChild(card);
    });

    // LIST view rows: file name + file type
    imgs.forEach((it) => {
      if (!it.url) return;

      const li = document.createElement("li");
      li.className = "images-list-row";

      const nameSpan = document.createElement("span");
      nameSpan.className = "col-filename";
      const displayName = it.name || it.url.split("/").pop() || it.url;

      const link = document.createElement("a");
      link.href = it.url;
      link.target = "_blank";
      link.textContent = displayName;
      nameSpan.appendChild(link);

      const typeSpan = document.createElement("span");
      typeSpan.className = "col-filetype";
      let ext = "—";
      // Prefer the file name if present, otherwise use the URL
      const sourceForExt = (it.name && it.name.includes(".")) ? it.name : it.url;
      const parts = sourceForExt.split(".");
      if (parts.length > 1) {
        ext = parts[parts.length - 1].split(/[#?]/)[0].toUpperCase();
      }
      typeSpan.textContent = ext;


      li.appendChild(nameSpan);
      li.appendChild(typeSpan);
      imagesList.appendChild(li);
    });

    applyImageViewMode();
  }

  // Tabs
  function initTabs() {
    const tabButtons = document.querySelectorAll(".tab-btn");
    const panels = {
      images: document.getElementById("tab-images"),
      data: document.getElementById("tab-data"),
    };

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-tab");

        tabButtons.forEach((b) => b.classList.remove("tab-btn-active"));
        btn.classList.add("tab-btn-active");

        Object.keys(panels).forEach((key) => {
          panels[key].classList.toggle(
            "tab-panel-active",
            key === target
          );
        });
      });
    });
  }

  function initImageSort() {
    const sortSelect = document.getElementById("image-sort");
    if (!sortSelect) return;

    sortSelect.addEventListener("change", renderImages);
  }

  function initImageView() {
    const viewSelect = document.getElementById("image-view");
    if (!viewSelect) return;

    currentViewMode = viewSelect.value === "list" ? "list" : "grid";
    applyImageViewMode();

    viewSelect.addEventListener("change", () => {
      currentViewMode = viewSelect.value === "list" ? "list" : "grid";
      applyImageViewMode();
    });
  }

  function initImageSearch() {
    const searchInput = document.getElementById("image-search");
    if (!searchInput) return;

    searchInput.addEventListener("input", () => {
      currentSearchTerm = searchInput.value || "";
      renderImages();
    });
  }

    function initDataAccordion() {
    const sections = document.querySelectorAll(".data-section-header");
    sections.forEach((header) => {
      header.addEventListener("click", () => {
        const section = header.closest(".data-section");
        section.classList.toggle("data-section-collapsed");
      });
    });
  }


  // Render package data into the page
  function renderPackageData(data) {
    if (data.error) {
      alert("Error: " + data.error);
      return;
    }

    const amlFiles = data.data || data.aml_files || {};
    const articleData = amlFiles['article.aml'] || {};

    let html = '';

    if (articleData.headline) {
      html += '<h1 class="display-4 mb-3">' + escapeHtml(articleData.headline) + '</h1>';
    }
    if (articleData.author) {
      html += '<p class="lead text-muted">By ' + escapeHtml(articleData.author) + '</p>';
    }
    if (articleData.authorbio) {
      html += '<p class="text-muted"><em>' + escapeHtml(articleData.authorbio) + '</em></p>';
    }
    if (articleData.authoremail) {
      html += '<p class="text-muted">Email: ' + escapeHtml(articleData.authoremail) + '</p>';
    }
    if (articleData.authortwitter) {
      html += '<p class="text-muted">Twitter: ' + escapeHtml(articleData.authortwitter) + '</p>';
    }
    if (articleData.excerpt) {
      html += '<p class="lead">' + escapeHtml(articleData.excerpt) + '</p>';
    }

    if (articleData.coverimg) {
      html += '<a href="' + escapeHtml(articleData.coverimg) + '" download>';
      html += '<img src="' + escapeHtml(articleData.coverimg) +
              '" class="img-fluid mb-4" alt="' +
              escapeHtml(articleData.coveralt || '') + '" />';
      html += '</a>';
    }

    if (articleData.covercred) {
      html += '<p class="text-muted small">' + escapeHtml(articleData.covercred) + '</p>';
    }
    if (articleData.coveralt && !articleData.coverimg) {
      html += '<p class="text-muted">' + escapeHtml(articleData.coveralt) + '</p>';
    }
    if (articleData.updated) {
      html += '<p class="text-muted small">Updated: ' + escapeHtml(articleData.updated) + '</p>';
    }
    if (articleData.articleType) {
      html += '<p class="text-muted small">Type: ' + escapeHtml(articleData.articleType) + '</p>';
    }

    const content = articleData.content || [];
    if (content.length > 0) {
      html += '<div class="article-content mt-4">';

      const fixedContent = [];
      for (let i = 0; i < content.length; i++) {
        const block = content[i];
        const nextBlock = content[i + 1];

        if (block.type === 'pull' &&
            (!block.value || !block.value.caption) &&
            nextBlock &&
            !nextBlock.type &&
            nextBlock.value &&
            nextBlock.value.caption) {
          fixedContent.push({
            type: 'pull',
            value: { caption: nextBlock.value.caption }
          });
          i++;
        } else {
          fixedContent.push(block);
        }
      }

      fixedContent.forEach(block => {
        if (block.type === 'text') {
          html += '<p class="mb-3">' + escapeHtml(block.value) + '</p>';
        } else if (block.type === 'pull') {
          const caption = (block.value && block.value.caption) ? block.value.caption : '';
          html += '<div class="card bg-light my-4 p-4">';
          html += '<blockquote class="blockquote mb-0">';
          html += '<p class="mb-0">' + escapeHtml(caption) + '</p>';
          html += '</blockquote>';
          html += '</div>';
        } else if (block.type === 'image') {
          const imageUrl = (block.value && block.value.url) ? block.value.url : '';
          const imageAlt = (block.value && block.value.alt) ? block.value.alt : '';
          const imageCaption = (block.value && block.value.caption) ? block.value.caption : '';
          const imageCredit = (block.value && block.value.credit) ? block.value.credit : '';

          html += '<figure class="my-4">';
          html += '<a href="' + escapeHtml(imageUrl) + '" download>';
          html += '<img src="' + escapeHtml(imageUrl) +
                  '" class="img-fluid" alt="' +
                  escapeHtml(imageAlt) + '" />';
          html += '</a>';
          if (imageCaption) {
            html += '<figcaption class="text-muted small mt-2">' +
                    escapeHtml(imageCaption) + '</figcaption>';
          }
          if (imageCredit) {
            html += '<p class="text-muted small">' +
                    escapeHtml(imageCredit) + '</p>';
          }
          html += '</figure>';
        }
      });

      html += '</div>';
    }

    if (!html && data.article) {
      html = '<pre style="white-space: pre-wrap;">' +
             escapeHtml(data.article) + '</pre>';
    }

    document.getElementById("article-container").innerHTML = html || "(empty)";

    const dataJson = data.data || data.aml_files || {};
    const filteredData = {};
    for (const key in dataJson) {
      if (key !== '_gridfs_aml') {
        filteredData[key] = dataJson[key];
      }
    }
    document.getElementById("data-container").textContent =
      JSON.stringify(filteredData, null, 2);

    document.getElementById("meta-container").textContent = "{}";

    currentImages = data.images || [];
    renderImages();
  }

  // --- Bootstrap page with cached data ---
  const initialPayload = JSON.parse(
    document.getElementById("initial-payload").textContent
  );
  


  // Fetch button handler
  const fetchBtn = document.getElementById("fetch-btn");
  if (fetchBtn) {
    fetchBtn.addEventListener("click", function () {
      const btn = this;
      const slug = "{{ package.slug }}";

      btn.disabled = true;
      const originalHTML = btn.innerHTML;
      btn.innerHTML = "Fetching...";

      fetch(`/packages/${slug}/fetch/`)
        .then((r) => {
          if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
          }
          return r.json();
        })
        .then((data) => {
          renderPackageData(data);
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        })
        .catch((err) => {
          alert("Fetch failed: " + err.message);
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        });
    });
  }

  function connectSortAndViewTriggers() {
  const sortTrigger = document.getElementById("sort-trigger");
  const sortSelect  = document.getElementById("image-sort");

  
  if (sortTrigger && sortSelect && sortSelect.showPicker) {
    sortTrigger.addEventListener("click", () => {
      sortSelect.showPicker();
    });
  }

 
}


renderPackageData(initialPayload);
initTabs();
initImageSort();
initImageView();
initImageSearch();
connectSortAndViewTriggers();   
initDataAccordion();
lucide.createIcons();


</script>

{% endblock %}
