{% extends 'packages/base.html' %} 
{% block content %}
<div class="container-fluid pkg-lst">
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <div>
      <button
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#newPackageModal"
      >
        + New Package
      </button>
      <button class="btn btn-secondary"><i class="bi bi-hdd icon-large"></i></button>
    </div>
    <div class="paginator">
      <ul class="pagination">
        <li class="page-item {% if not packages.has_previous %}disabled{% endif %}">
          <a 
          class="page-link" 
          href="?{% if active_category %}category={{ active_category }}&{% endif %}{% if packages.has_previous %}page={{ packages.previous_page_number }}{% else %}#{% endif %}"
          {% if not packages.has_previous %}
          aria-disabled="true"
          {% endif %}
          ><i class="bi bi-chevron-left"></i></a>
        </li>
        {% for page_num in visible_page_range %}
        <li class="page-item">
          <a class="page-link {% if page_num == packages.number %}active{% endif %}" 
            href="?{% if active_category %}category={{ active_category }}&{% endif %}page={{ page_num }}">
            {{page_num}}
          </a>
        </li>
        {% endfor %}
        <li class="page-item {% if not packages.has_next %} disabled {% endif %}">
          <a 
          class="page-link" 
          href="?{% if active_category %}category={{ active_category }}&{% endif %}{% if packages.has_next %}page={{ packages.next_page_number }}{% else %}#{% endif %}">
            <i class="bi bi-chevron-right"></i></a>
        </li>
      </ul>
    </div>
  </div>
  <div>
    {% include 'components/search_bar.html' %}
  </div>
  {% if messages %}
  <div>
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}" role="alert">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="custom-table card">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Slug <button class="table-button"><i class="bi bi-chevron-down"></i></button></th>
          <th>Description</th>
          <th>Publish Date<button class="table-button"><i class="bi bi-chevron-down"></i></button></th>
          <th>Last Fetched<button class="table-button"><i class="bi bi-chevron-down"></i></button></th>
          <th>GDrive</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for pkg in packages %}
        <tr>
          <td>
            <a href="{% url 'package_detail' slug=pkg.slug %}"
              >{{ pkg.slug }}</a
            >
          </td>
          <td>{{ pkg.description|default_if_none:""|truncatechars:60 }}</td>
          <td>{{ pkg.publish_date }}</td>
          <td>{{ pkg.last_fetched_date }}</td>
          <td>
            {% if pkg.google_drive_url %}<a
              href="{{ pkg.google_drive_url }}"
              target="_blank"
              ><i class="bi bi-link-45deg"></i></a
            >{% endif %}
          </td>
          <td><button class="table-button"><i class="bi bi-pin-angle"></i></button></td>
          <td><form action="{% url 'package_delete' pkg.pk %}" method="post">
            {%csrf_token%}
            <button class="table-button"><i class="bi bi-trash3"></i></button></form>
          </td>
          
        </tr>
        {% empty %}
        <tr>
          <td colspan="6">
            {% if search_query %}
              No packages found matching "{{ search_query }}".
            {% else %}
              No packages found.
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- New Package Modal -->
<div class="modal fade" id="newPackageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Package</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form method="post">
        <div class="modal-body">
          {% csrf_token %} {% if form.errors %}
          <div class="alert alert-danger">Please fix the errors below.</div>
          {% endif %}
          <div class="mb-3">
            <label class="form-label d-block">Slug:</label>
            {{ form.slug }}
          </div>
          <div class="mb-3">
            <label class="form-label d-block">Description:</label>
            {{ form.description }}
          </div>
          <div class="mb-3">
            <label class="form-label d-block">Google Drive URL:</label>
            {{ form.google_drive_url }}
          </div>
          <div class="mb-3">
            <label class="form-label d-block">Publish Date:</label>
            {{ form.publish_date }}
          </div>
          <div class="mb-3">
            <label class="form-label d-block">Category:</label>
            {{ form.category }}
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-center">
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if form.errors %}
<script>
  // If the form had errors on server-side validation, re-open the modal so the user can see them.
  document.addEventListener("DOMContentLoaded", function () {
    var modalEl = document.getElementById("newPackageModal");
    if (modalEl) {
      var modal = new bootstrap.Modal(modalEl);
      modal.show();
    }
  });
</script>
{% endif %} {% endblock %}
